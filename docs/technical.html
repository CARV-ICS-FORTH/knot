

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Technical overview &mdash; Karvdash  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API documentation" href="api.html" />
    <link rel="prev" title="User guide" href="user.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Karvdash
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="user.html">User guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Technical overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#storage-management">Storage management</a></li>
<li class="toctree-l2"><a class="reference internal" href="#remote-datasets">Remote datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#service-templates">Service templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#user-namespaces">User namespaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="#service-exposure">Service exposure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sso-service">SSO service</a></li>
<li class="toctree-l2"><a class="reference internal" href="#registry-gateway">Registry gateway</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Karvdash</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Technical overview</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/technical.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="technical-overview">
<h1>Technical overview<a class="headerlink" href="#technical-overview" title="Permalink to this headline">¶</a></h1>
<div class="section" id="storage-management">
<h2>Storage management<a class="headerlink" href="#storage-management" title="Permalink to this headline">¶</a></h2>
<p>In a cluster environment, it is common for each user to have a “home folder”, usually mounted over NFS, Lustre, Gluster, etc. Karvdash tries to apply this notion in a containerized environment: Given a cluster-wide shared folder, this folder is also mounted inside containers as well. Thus, when running a notebook server (like Jupyter), user data is available in the containerized environment at a well-known path - as it would be in a bare-metal cluster node. This, in addition to the web-based file browser provided by Karvdash, facilitates easy data management for applications, both for providing inputs and collecting outputs.</p>
<p>In Karvdash, there are two such folders/data domains:</p>
<ul class="simple">
<li><p>Private: User data that is private to the user. Mounted in containers under <code class="docutils literal notranslate"><span class="pre">/private</span></code>.</p></li>
<li><p>Shared: Data that is shared among all users. Mounted in containers under <code class="docutils literal notranslate"><span class="pre">/shared</span></code>.</p></li>
</ul>
<p>For the first domain Karvdash creates a subfolder for each user, named after the corresponding username and only allows access within that subfolder (like a “home folder”). This is hidden to the user, meaning that <code class="docutils literal notranslate"><span class="pre">/private</span></code> is the user subfolder itself. Users cannot go up a level and check other users’ names and files.</p>
<div class="figure align-default" id="id1">
<img alt="_images/service-layout.png" src="_images/service-layout.png" />
<p class="caption"><span class="caption-text">The dashboard runs as a service in Kubernetes and coordinates the execution of other services in particular namespaces. All provisioned containers of a user share common volumes.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>To attach these data folders to service and application containers, Karvdash creates Persistent Volumes and associated Persistent Volume Claims for each user, and provides a Kubernetes mutating admission webhook which intercepts all calls to create pods or deployments and injects the appropriate volumes to respective configurations before they are applied. The Karvdash service itself also has the same data folders mounted in order to present their contents via the dashboard. Also, another validating admission webhook makes sure that only allowed host paths can be mounted in pods.</p>
</div>
<div class="section" id="remote-datasets">
<h2>Remote datasets<a class="headerlink" href="#remote-datasets" title="Permalink to this headline">¶</a></h2>
<p>In addition to the “private” and “shared” data domains, Karvdash optionally interfaces with <a class="reference external" href="https://github.com/datashim-io/datashim">Datashim</a> to mount internal or external S3 and H3 buckets to running containers. Karvdash provides the frontend to configure datasets and then attaches the produced Persistent Volume Claims to deployed pods. Datasets are mounted in containers at <code class="docutils literal notranslate"><span class="pre">/mnt/datasets/&lt;name&gt;</span></code>.</p>
</div>
<div class="section" id="service-templates">
<h2>Service templates<a class="headerlink" href="#service-templates" title="Permalink to this headline">¶</a></h2>
<p>Karvdash provides a way for users to easily configure and start services, by integrating a simple service templating mechanism - practically YAML files with variables. The user can specify execution parameters through the dashboard before deployment, and Karvdash will set other “internal” platform configuration values, such as private container registry location, external DNS name, etc. Moreover, Karvdash automatically manages service names when starting multiple services from the same template, while it also allows “singleton” services that can only be deployed once per user.</p>
<p>To convert a YAML deployment into a Karvdash service template:</p>
<ul class="simple">
<li><p>Replace strings with variables where necessary.</p></li>
<li><p>Add a “Template” section with variable names, their default values and optional help text.</p></li>
<li><p>Make sure there is exactly one “Service” section named using the variable <code class="docutils literal notranslate"><span class="pre">NAME</span></code>. If the template contains multiple services, Karvdash will use the first one (you can skip previous services by labeling them with <code class="docutils literal notranslate"><span class="pre">karvdash-hidden=true</span></code>).</p></li>
<li><p>Optionally have an “Ingress” section pointing to the service (the dashboard will provide a link to the hostname assigned to the ingress if there is one).</p></li>
</ul>
<p>The “Template” section should contain the following fields:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 13%" />
<col style="width: 7%" />
<col style="width: 80%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Field</p></td>
<td><p>Required</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">kind</span></code></p></td>
<td><p>Yes</p></td>
<td><p>Set to <code class="docutils literal notranslate"><span class="pre">Template</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">name</span></code></p></td>
<td><p>Yes</p></td>
<td><p>The template name to show in the dashboard</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">description</span></code></p></td>
<td><p>No</p></td>
<td><p>A simple, short description</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">singleton</span></code></p></td>
<td><p>No</p></td>
<td><p>If set, only one instance of the template can be running (unset by default)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">auth</span></code></p></td>
<td><p>No</p></td>
<td><p>If set, HTTP authentication should be added by the ingress (set by default)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">datasets</span></code></p></td>
<td><p>No</p></td>
<td><p>If set, dataset volumes will be mounted in pods (set by default)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">variables</span></code></p></td>
<td><p>Yes</p></td>
<td><p>The template variables (<code class="docutils literal notranslate"><span class="pre">name</span></code> and <code class="docutils literal notranslate"><span class="pre">default</span></code> required, <code class="docutils literal notranslate"><span class="pre">choices</span></code> and <code class="docutils literal notranslate"><span class="pre">help</span></code> optional)</p></td>
</tr>
</tbody>
</table>
<p>An example template is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># hello-kubernetes.template.yaml

apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: $NAME
spec:
  rules:
  - host: $HOSTNAME
    http:
      paths:
      - backend:
          serviceName: $NAME
          servicePort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: $NAME
spec:
  type: ClusterIP
  ports:
  - port: 8080
  selector:
    app: $NAME
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: $NAME
spec:
  replicas: 1
  selector:
    matchLabels:
      app: $NAME
  template:
    metadata:
      labels:
        app: $NAME
    spec:
      containers:
      - name: $NAME
        image: paulbouwer/hello-kubernetes:1.5
        ports:
        - containerPort: 8080
        env:
        - name: MESSAGE
          value: $MESSAGE
---
kind: Template
name: Hello Kubernetes
description: Show a message in a web page
variables:
- name: NAME
  default: hello-kubernetes
- name: HOSTNAME
  default: hello-kubernetes.example.com
- name: MESSAGE
  default: I just deployed this on Kubernetes!
  help: Message to display
</pre></div>
</div>
<p>The following variables are automatically set by Karvdash. If they are used in a template, they are not presented to the user, but rather their values are filled in by Karvdash before starting a service.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 23%" />
<col style="width: 78%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Field</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">NAMESPACE</span></code></p></td>
<td><p>The namespace that the service will run in</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code></p></td>
<td><p>The external hostname that will be assigned to the service</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">REGISTRY</span></code></p></td>
<td><p>The private container registry configured for the installation</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">PRIVATE_DIR</span></code></p></td>
<td><p>The path to the “private” data domain</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">PRIVATE_VOLUME</span></code></p></td>
<td><p>The volume used for the “private” data domain</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SHARED_DIR</span></code></p></td>
<td><p>The path to the “shared” data domain</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SHARED_VOLUME</span></code></p></td>
<td><p>The volume used for the “shared” data domain</p></td>
</tr>
</tbody>
</table>
<p>Karvdash distinguishes between internal system templates, which are stored in the filesystem and can not be changed, and custom user templates, which are stored as CRDs in Kubernetes in the user’s namespace. To manage service templates with <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> use the <code class="docutils literal notranslate"><span class="pre">templates</span></code> resource identifier (i.e., <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">templates</span></code>).</p>
</div>
<div class="section" id="user-namespaces">
<h2>User namespaces<a class="headerlink" href="#user-namespaces" title="Permalink to this headline">¶</a></h2>
<p>Internally, at the Kubernetes level, each Karvdash user is matched to a unique namespace, which also hosts all of the user’s services. Containers launched within the namespace are given Kubernetes service accounts which are only allowed to operate within their own namespace. This practice organizes resources per user and isolates users from each other.</p>
<p>For user “test”, Karvdash creates the namespace <code class="docutils literal notranslate"><span class="pre">karvdash-test</span></code> and binds the <code class="docutils literal notranslate"><span class="pre">default</span></code> user account in that namespace to the <code class="docutils literal notranslate"><span class="pre">cluster-admin</span></code> cluster role (only for the <code class="docutils literal notranslate"><span class="pre">karvdash-test</span></code> namespace).</p>
</div>
<div class="section" id="service-exposure">
<h2>Service exposure<a class="headerlink" href="#service-exposure" title="Permalink to this headline">¶</a></h2>
<p>To expose services to the user, Karvdash makes use of a Kubernetes ingress - a proxy server. Service templates that provide a user-facing service include an ingress directive. Karvdash effectively:</p>
<ul class="simple">
<li><p>Exposes all services on subdomains of the main dashboard domain. These domains are composed of the service name and the username, so they can always be the same, allowing the user to bookmark the location.</p></li>
<li><p>Protects all services with an authentication/authorization mechanism, by configuring each respective ingress to perform single sing-on through the dashboard. The default deployment integrates <a class="reference external" href="https://github.com/vouch/vouch-proxy">Vouch Proxy</a> as an OAuth 2.0/OIDC client to the dashboard, which in turn provides credentials to the NGINX-based web proxy implementing the ingress. Thus, each service can only be accessed by its owner. This helps avoiding any external party visiting a user’s service frontend without appropriate credentials.</p></li>
<li><p>Incorporates all services under a common SSL environment, so all data sent back-and-forth through each ingress is encrypted.</p></li>
</ul>
<p>Assuming that the dashboard is accessible at <code class="docutils literal notranslate"><span class="pre">example.com</span></code>, the “File Browser” service named <code class="docutils literal notranslate"><span class="pre">browser</span></code> started by user “test” will be exposed at <code class="docutils literal notranslate"><span class="pre">browser-test.example.com</span></code>. Karvdash will also inject appropriate rules to the service’s ingress configuration, so that no other user can access <code class="docutils literal notranslate"><span class="pre">browser-test.example.com</span></code>. As the ingress will be configured with an SSL certificate for both <code class="docutils literal notranslate"><span class="pre">example.com</span></code> and <code class="docutils literal notranslate"><span class="pre">*.example.com</span></code>, all connections will be SSL terminated.</p>
</div>
<div class="section" id="sso-service">
<h2>SSO service<a class="headerlink" href="#sso-service" title="Permalink to this headline">¶</a></h2>
<p>Karvdash implements an OAuth 2.0/OpenID Connect provider, which allows third-party services to request verification of users’ identities via standard protocols. Note that OAuth 2.0/OpenID provides only authentication information and it is up to the connecting service to define what users are authorized to do, based on their identities (i.e., username, email, etc.). In addition to the integration with Vouch Proxy for authenticating users to services started by the dashboard, Karvdash also acts as an identity provider to <a class="reference external" href="https://jupyter.org/hub">JupyterHub</a> and <a class="reference external" href="https://argoproj.github.io/workflows">Argo Workflows</a>. Moreover, Karvdash configures appropriate authorization directives in Argo Workflows, so each user will be allowed to access resources in the corresponding Karvdash-defined namespace.</p>
</div>
<div class="section" id="registry-gateway">
<h2>Registry gateway<a class="headerlink" href="#registry-gateway" title="Permalink to this headline">¶</a></h2>
<p>Additionally, Karvdash provides a graphical frontend to a private container registry, so users can easily manage available private container images and upload new ones from files (exported images). Note that the registry is shared between users, so each user may add new images, but only admins can delete them.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="api.html" class="btn btn-neutral float-right" title="API documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="user.html" class="btn btn-neutral float-left" title="User guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, FORTH-ICS.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>